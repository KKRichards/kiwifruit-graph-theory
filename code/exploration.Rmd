---
title: "kiwifruit graph theory"
author: "Patrick Snelgar"
date: "`r {format(Sys.Date(), '%d %M %Y')}`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidygraph)
library(tidyverse)
library(ggraph)
library(magrittr)
#library(igraph)
#library(gganimate)
library(htmlwidgets)
library(plotly)
library(ggplot2)
library(gplots)
library(scales)
```


```{r data-import, echo=FALSE}

quadrant_info <- read_csv("input/quadrant-info.csv")

quadrant_labels <- data.frame(x = rep(c(-1250, -750, -250, 250, 750, 1250), each = 6),
							  y = rep(c(2500, 1500, 500, -500, -1500, -2500), 6),
							  label = 1:36)

flowering_dates <- read_csv("input/flowering_dates.csv")

```

```{r vine2_fake_data, include = FALSE}
#' Create list of only shoot IDs
#'  then generate random # of fruit per shoot 9inc 0's)
#' temp_rep is used to keep the shoot id when generating the fruit data frame 
#'  so it keeps ALL shoot ids even if there is 'no' fruit on that shoot
# shoot_data <- vine2_data %>%
# 				filter(!is.na(to_shoot_id)) %>%
# 				select(to_shoot_id) %>%
# 				mutate(num_fruit = as.integer(runif(length(to_shoot_id), 0, 6))) %>%
# 				mutate(temp_rep = replace(num_fruit, which(num_fruit == 0), 1))
# 				
# 
# fruit_data <- shoot_data[rep(row.names(shoot_data), shoot_data$temp_rep), 1:2] %>%
# 				mutate(fruit_id = ifelse(num_fruit != 0, paste("2-", 1:length(to_shoot_id)), NA)) %>%
# 				mutate(dm = ifelse(num_fruit > 0, runif(length(!is.na(fruit_id)), 16,19), NA)) %>%
# 				mutate(fw = ifelse(num_fruit > 0, runif(length(!is.na(fruit_id)), 120, 150), NA))
```


```{r functions, echo = FALSE}

# maximum 9 fruit per shoot
angle <- 2 * pi / 9

pointXOffset <- function (central_xpoint, radius, point_pos){
	return(central_xpoint + radius * cos(point_pos * angle))
}

pointYOffset <- function (central_ypoint, radius, point_pos){
	return(central_ypoint + radius * sin(point_pos * angle))
}

```

```{r all_vines_plot, echo = FALSE}

all_fruit_data <- bind_rows(vine4_fruit_data, vine5_fruit_data, vine6_fruit_data, vine7_fruit_data, vine8_fruit_data, vine9_fruit_data) %>%
					mutate(dm_bins = cut(DryMatter, seq(0, 30, by = 1), include.lowest = TRUE, labels = paste((0:29), "to", (1:30))))

all_arch_data <- bind_rows(mutate(vine4_links, Vine = 4),
						   mutate(vine5_links, Vine = 5),
						   mutate(vine6_links, Vine = 6),
						   mutate(vine7_links, Vine = 7),
						   mutate(vine8_links, Vine = 8),
						   mutate(vine9_links, Vine = 9)) 

all_arch_data %>%
	filter(is.na(to)) %>%
	select(from:ystart, origin_target_id, to_origin_id, Vine)
					
vine_labels <- paste("Vine", 4:9)
names(vine_labels) <- c(4:9)
					
ggplot(filter(all_arch_data, !is.na(xend) & !is.na(yend))) +
	geom_segment(aes(x = ystart, y = xstart, xend = yend, yend = xend, size = diameter), colour = "lightgrey") +
	scale_size_continuous(name = "Segment diameter", breaks = pretty_breaks(10)) +
	geom_jitter(aes(yend, xend, fill = dm_bins),
				data = filter(all_fruit_data, !is.na(dm_bins) & DryMatter > 12),
				alpha = 0.8,
				size = 4,
				width = 10,
				height = 70,
				shape = 21) +
	scale_fill_brewer(type = "div", palette = "RdYlBu", direction = "-1") +
	labs(x = NULL, y = NULL, caption = "Fruit below 12% dm units are excluded (n = 2)") +
	facet_wrap(~Vine, labeller = labeller(Vine = vine_labels)) +
	guides(size = FALSE) +
	ggtitle("Dry Matter by Vine") +
	theme_bw() +
	theme(plot.title = element_text(size = 22, hjust = 0.5),
		  axis.ticks = element_blank(),
		  axis.text = element_blank(),
		  strip.text.x = element_text(size = 12))
	
ggsave("output/vine 4 - 9 dry matter map.jpg", width = 20, height = 15)
```

```{r vine1, echo=FALSE}

source("code/sources/vine1.R")

```

```{r vine2, echo=FALSE}

source("code/sources/vine2.R")

```

```{r vine3, echo=FALSE}

source("code/sources/vine3.R")

```

```{r vine4, echo=FALSE}

source("code/sources/vine4.R")

```

```{r vine5, echo=FALSE}

source("code/sources/vine5.R")

```

```{r vine6, echo=FALSE}

source("code/sources/vine6.R")

```

```{r vine7, echo=FALSE}

source("code/sources/vine7.R")

```

```{r vine8, echo=FALSE}

source("code/sources/vine8.R")

```

```{r vine9, echo=FALSE}

source("code/sources/vine9.R")

```
